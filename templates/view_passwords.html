<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Passwords</title>
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <div class="dropdown">
        <button class="dropdown-button">Menu</button>
        <div class="dropdown-content">
          <a href="/profile">Back to Profile</a>
          <a href="#" onclick="logout()">Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="login-card">
      <h1 class="title">Your Saved Passwords</h1>
      <table class="password-table">
        <thead>
          <tr>
            <th>Service</th>
            <th>Username</th>
            <th>Password</th>
          </tr>
        </thead>
        <tbody id="password-table-body">

        </tbody>
      </table>
    </div>
  </div>

  <div id="notification-modal" class="notification-modal">
    <div class="notification-content">
      <p id="notification-message"></p>
    </div>
  </div>

  <script src="/static/main.js"></script>
  <script>
    async function fetchPasswords() {
      try {
        const response = await fetch("/get-all-passwords", {
          method: "GET",
        });

        if (response.ok) {
          const passwords = await response.json();
          const tableBody = document.getElementById("password-table-body");

          tableBody.innerHTML = "";

          passwords.forEach(({ service, username, password }) => {
            const row = document.createElement("tr");

            const serviceCell = document.createElement("td");
            serviceCell.textContent = service;

            const usernameCell = document.createElement("td");
            usernameCell.textContent = username;

            const passwordCell = document.createElement("td");
            passwordCell.textContent = password;

            const deleteCell = document.createElement("td");
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.className = "btn-delete";
            deleteButton.onclick = () => confirmDelete(service, username);
            deleteCell.appendChild(deleteButton);

            row.appendChild(serviceCell);
            row.appendChild(usernameCell);
            row.appendChild(passwordCell);
            row.appendChild(deleteCell);

            tableBody.appendChild(row);
          });
        } else {
          console.error("Failed to fetch passwords.");
        }
      } catch (error) {
        console.error("Error fetching passwords:", error);
      }
    }

    async function confirmDelete(service, username) {
      const confirmation = confirm(`Are you sure you want to delete the password for ${username} on ${service}?`);
      if (confirmation) {
        await deletePassword(service, username);
      }
    }

    async function deletePassword(service, username) {
      try {
        const response = await fetch("/delete-password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ service, username }),
        });

        const data = await response.json();
        if (response.ok) {
          alert(data.success);
          fetchPasswords();
        } else {
          alert(data.error || "An unknown error occurred.");
        }
      } catch (error) {
        console.error("Error deleting password:", error);
        alert("Failed to delete the password. Please try again.");
      }
    }

    document.addEventListener("DOMContentLoaded", fetchPasswords);
  </script>
</body>
</html>